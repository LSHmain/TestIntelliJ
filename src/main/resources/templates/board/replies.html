<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>댓글 목록</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="container py-4">
<h2>댓글 목록</h2>
<div>
  <button class="btn btn-primary addReply">댓글 작성</button>
  <span class="replyCount badge bg-secondary ms-3">Reply Count : 0</span>
</div>

<hr/>
<div class="row replyList"></div>

<!-- 댓글 작성/수정 모달 -->
<div class="modal" tabindex="-1" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <input type="hidden" name="rno" />
      <div class="mb-2">
        <label>댓글 내용</label>
        <input type="text" name="replyText" class="form-control" />
      </div>
      <div class="mb-2">
        <label>작성자</label>
        <input type="text" name="replyer" class="form-control" />
      </div>
      <div class="mb-2">
        <label>이미지 첨부</label>
        <input type="file" id="imageFile" accept="image/*" class="form-control"/>
        <img id="preview" style="max-width: 200px; display: none; margin-top: 10px;" />
      </div>
      <div class="text-end">
        <button class="btn btn-success replySave">저장</button>
        <button class="btn btn-warning replyModify">수정</button>
        <button class="btn btn-danger replyRemove">삭제</button>
        <button class="btn btn-secondary replyClose">닫기</button>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  const bno = /*[[${bno}]]*/ 0;

  function f_selectAll() {
    $.ajax({
      url:`/board/${bno}/replies`,
      success:f_display
    });
  }

  function f_display(replyList) {
    let output = '';
    $(".replyCount").html("Reply Count : " + replyList.length);
    $.each(replyList, function(index, reply){
      output += `
			      <div class="col-sm-6">
					  <div class='card card-body mb-2' data-rno='${reply.rno}' data-replyText="${reply.replyText}" data-replyer="${reply.replyer}" style="width: 100%;"  >
	  				        <b>${reply.rno}</b>
	  				        <h5 class='card-title' >${reply.replyText}</h5>
	  				        <h6 class='card-subtitle mb-2 text-muted' >${reply.replyer}</h6>
                            ${reply.imageUrl ? `<img src="${reply.imageUrl}" style="max-width:100%; margin-top: 5px;" />` : ""}
	  				        <p class='card-text'>등록일: ${reply.regDate}</p>
	  				        <p class='card-text'>수정일: ${reply.modDate}</p>
	  				  </div>
  			     </div>`;
    });
    $(".replyList").html(output);
  }

  function f_add() {
    $(".modal").show();
  }

  function f_close(){
    $("input[name='replyText']").val("");
    $("input[name='replyer']").val("");
    $("input[name='rno']").val("");
    $("#imageFile").val("");
    $("#preview").hide().attr("src", "");
    $(".modal").hide();
  }

  function f_detailDisplay() {
    const rno = $(this).data("rno");
    const replyText = $(this).data("replytext");
    const replyer = $(this).data("replyer");

    $("input[name='replyText']").val(replyText);
    $("input[name='replyer']").val(replyer);
    $("input[name='rno']").val(rno);
    $(".modal").show();
  }

  function f_insertSuccess(msg) {
    alert(msg);
    f_close();
    f_selectAll();
  }

  function sendReply(bno, replyText, replyer, imageUrl) {
    const insertData = {
      replyText,
      replyer,
      imageUrl
    };
    $.ajax({
      url: `/board/${bno}/replies`,
      method: "POST",
      contentType: 'application/json',
      data: JSON.stringify(insertData),
      success: f_insertSuccess
    });
  }

  function f_save() {
    const replyText = $("input[name='replyText']").val();
    const replyer = $("input[name='replyer']").val();
    const imageFile = $("#imageFile")[0].files[0];

    if (imageFile) {
      const formData = new FormData();
      formData.append("uploadFiles", imageFile);
      formData.append("mid", replyer);

      $.ajax({
        url: "/upload/uploadAjax",
        method: "POST",
        processData: false,
        contentType: false,
        data: formData,
        success: function (uploadResults) {
          console.log("uploadResults: ", uploadResults);
          const uploaded = uploadResults[0];
          const imageUrl = "/display?fileName=" + uploaded.folderPath + "/" + uploaded.uuid + "_" + uploaded.fileName;
          sendReply(bno, replyText, replyer, imageUrl);
        }
      });
    } else {
      sendReply(bno, replyText, replyer, null);
    }
  }

  function f_update(){
    const replyText = $("input[name='replyText']").val();
    const replyer = $("input[name='replyer']").val();
    const rno = $("input[name='rno']").val();
    const insertData = { replyText, replyer, rno };

    $.ajax({
      url: `/board/${bno}/replies/${rno}`,
      method: "PUT",
      contentType: 'application/json',
      data: JSON.stringify(insertData),
      success: f_insertSuccess
    });
  }

  function f_delete(){
    const rno = $("input[name='rno']").val();
    $.ajax({
      url: `/board/${bno}/replies/${rno}`,
      method: "DELETE",
      success: f_insertSuccess
    });
  }

  $("#imageFile").change(function () {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        $("#preview").attr("src", e.target.result).show();
      }
      reader.readAsDataURL(file);
    }
  });

  $(function() {
    $(".replyCount").click(f_selectAll);
    $(".addReply").click(f_add);
    $(".replyClose, .close").click(f_close);
    $(".replySave").click(f_save);
    $(".replyList").on("click", ".card-body", f_detailDisplay);
    $(".replyModify").click(f_update);
    $(".replyRemove").click(f_delete);
    f_selectAll(); // 페이지 로드시 댓글 목록 표시
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
